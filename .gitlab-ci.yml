stages:
  - deploy

before_script:
  - cp deploy/* .
  - chmod +x *.sh
  - rm -rf deploy
  - ls -l
  - ls | wc -l

deploy to NDevelopment-web-user:
  stage: deploy
  environment:
    name: ndevelopment-web-user
  when: manual
  before_script:
    - ls 
  script:
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "cd $web_user_work_dir; pwd; ls;"
    - scp -r -P$ssh_port * "$ssh_user"@"$server_ip":"$web_user_work_dir"
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "cd $web_user_work_dir; free -h; sh -x web-user_dev.sh"
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "sleep 40; rm -rf $web_user_work_dir/*.sh; ls $web_user_work_dir && netstat -tnlp"
  only:
    - dev-deploy

deploy to NDevelopment-admin:
  stage: deploy
  environment:
    name: ndevelopment-admin
  when: manual
  before_script:
    - ls 
  script:
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "cd $admin_work_dir; pwd; ls"
    - scp -r -P$ssh_port * "$ssh_user"@"$server_ip":"$admin_work_dir"
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "cd $admin_work_dir; free -h; sh -x admin.sh"
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "sleep 40; rm -rf $admin_work_dir/*.sh; ls $admin_work_dir && netstat -tnlp"
    #sh -x admin.sh"
    #- ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "sleep 40; rm -rf $admin_work_dir/*.sh; ls $admin_work_dir && netstat -tnlp"
  only:
    - dev-deploy
#backend_build:
#  stage: build
#  when: manual
#  only:
#    changes:
#      - "backend/**/*"
#  script:
#    - docker login -u $DOCKER_USER -p $ACCESS_TOKEN $CI_REGISTRY
#    - cd backend
#    - docker build -f Dockerfile --tag latest .
#    - docker push latest

#stages:
#    - trigger-child-pipelines
#when: manual
#web-client:
#    stage: trigger-child-pipeline
#    trigger:
#        include: web-client/.gitlab-ci.yml
#        strategy: depend
#    only:
#        changes:
#            - web-client/**/*

#.backend-setup:
#    before_script:
#        - cd backend

#test:
#    extends: .backend-setup
#    stage: test
#    script:
#        - mvn test
