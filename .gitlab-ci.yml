stages:
  - deploy


deploy to Production-web-user:
  stage: deploy
  environment:
    name: web-user-prod
  when: manual
  before_script:
  - cp deploy/* .
  - chmod +x *.sh
  - rm -rf deploy
  - tar -cvf admin.tar *
  - ls -l
  - ls | wc -l
  script:
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "cd $web_user_work_dir; pwd; ls;"
    - scp -r -P$ssh_port *.tar "$ssh_user"@"$server_ip":"$web_user_work_dir"
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "cd $web_user_work_dir; free -h; tar -xvf *.tar; sh -x web-user_dev.sh"
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "sleep 40; rm -rf $web_user_work_dir/*.sh; rm -rf $web_user_work_dir/*.tar; ls $web_user_work_dir && netstat -tnlp"
  only:
    - prod-deploy




deploy to Production-admin:
  stage: deploy
  environment:
    name: admin-prod
  when: manual
  before_script:
  - cp deploy/* .
  - chmod +x *.sh
  - rm -rf deploy
  - tar -cvf admin.tar *
  - ls -l
  - ls | wc -l
  script:
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "cd $admin_work_dir; pwd; ls"
    - scp -r -P$ssh_port *.tar "$ssh_user"@"$server_ip":"$admin_work_dir"
    #- scp -r -P$ssh_port * "$ssh_user"@"$server_ip":"$admin_work_dir"
    #- scp -r -P$ssh_port admin.sh "$ssh_user"@"$server_ip":"$admin_work_dir"
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "cd $admin_work_dir; free -h; tar -xvf *.tar; sh -x admin.sh"
    - ssh -p "$ssh_port" "$ssh_user"@"$server_ip" "sleep 40; rm -rf $admin_work_dir/*.sh; rm -rf $admin_work_dir/*.tar; ls $admin_work_dir && netstat -tnlp"
  only:
    - prod-deploy
