<div
  class="caption__wrapper"
  [ngClass]="{
    'header-background': tableFG?.get('tableType').value !== 'card'
  }"
>
  <form [formGroup]="tableFG">
    <div class="caption__wrapper--tabmenu">
      <div class="header">
        <!-- <div class="header--text"> -->
        <img src="assets/svg/surveyor.svg" alt="" /> &nbsp;
        <p class="heading">
          {{ tableName }}
        </p>
        <div class="mark-btn-container">
          <!-- <div class="request-btn" (click)="openFeedbackRequestPage($event)">
            <div class="request-btn__wrap">
              {{ 'request_feedback_label' | translate }}
            </div>
          </div> -->
          <div class="btn read" *ngIf="selectedRows.length > 0">
            <img
              [src]="globalFeedbackConfig.images.datatable.mark_as_read.url"
              [alt]="globalFeedbackConfig.images.datatable.mark_as_read.alt"
              (click)="updateFeedbackStatus(true)"
            />
            <span class="btn_text">
              {{ 'datatable.mark_as_read' | translate }}
            </span>
          </div>
          <div class="btn" *ngIf="selectedRows.length > 0">
            <img
              [src]="globalFeedbackConfig.images.datatable.mark_as_unread.url"
              [alt]="globalFeedbackConfig.images.datatable.mark_as_unread.alt"
              (click)="this.updateFeedbackStatus(false)"
            />
            <span class="btn_text">
              {{ 'datatable.mark_as_unread' | translate }}
            </span>
          </div>
        </div>
        <div class="action-wrapper">
          <div class="pull-right">
            <label class="labl" *ngFor="let option of tableTypes">
              <input
                type="radio"
                formControlName="tableType"
                [value]="option.value"
                (click)="setTableType(option.value)"
              />
              <div class="image">
                <img [src]="option.url" [alt]="option.value" />
              </div>
            </label>
          </div>
          <hospitality-bot-export-list
            (onDocumentActions)="onDocumentActions()"
            [documentTypes]="documentTypes"
            [documentActionTypes]="documentActionTypes"
          ></hospitality-bot-export-list>
        </div>
      </div>
      <div
        *ngIf="
          isTabFilters &&
          tabFilterItems &&
          tableFG?.get('tableType').value !== 'card'
        "
      >
        <hospitality-bot-tab-group
          [listItems]="tabFilterItems"
          [selectedIndex]="tabFilterIdx"
          (selectedTabChange)="onSelectedTabFilterChange($event)"
        ></hospitality-bot-tab-group>
      </div>
    </div>
    <hospitality-bot-filter-chips
      *ngIf="isQuickFilters && tableFG?.get('tableType').value !== 'card'"
      [chips]="tabFilterItems[tabFilterIdx].chips"
      (onChange)="toggleQuickReplyFilter($event)"
    ></hospitality-bot-filter-chips>
  </form>
</div>
<ng-container
  *ngIf="tableFG?.get('tableType').value === 'card'; else tableView"
>
  <div class="sideMargin">
    <hospitality-bot-main #cardComponent></hospitality-bot-main>
  </div>
</ng-container>
<ng-template #tableView>
  <p-table
    #dt
    [styleClass]="tableConfig.styleClass"
    [resizableColumns]="isResizableColumns"
    [autoLayout]="isAutoLayout"
    [loading]="loading"
    [columns]="cols"
    [value]="values"
    [paginator]="isPaginaton"
    [rows]="rowsPerPage"
    [showCurrentPageReport]="showCurrentPageReport"
    [rowsPerPageOptions]="rowsPerPageOptions"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [(first)]="first"
    [totalRecords]="totalRecords"
    [filterDelay]="0"
    [selectionMode]="selectionMode"
    [(selection)]="selectedRows"
    (onRowSelect)="onRowSelect($event)"
    (onRowUnselect)="onRowUnselect($event)"
    (sortFunction)="customSort($event)"
    [customSort]="isCustomSort"
    (onFilter)="onDataFilter($event)"
  >
    <!-- <ng-template pTemplate="caption"> </ng-template> -->

    <ng-template pTemplate="emptymessage">
      <hospitality-bot-empty-view></hospitality-bot-empty-view>
    </ng-template>
    <!-- *******************************HEADER WITH SEARCH******************************* -->
    <ng-template pTemplate="header" let-columns>
      <tr>
        <th
          *ngIf="isSelectable"
          id="select-all"
          class="table-search-head select-box"
          pResizableColumn
        >
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th
          [id]="col.fields"
          class="table-data-head"
          pResizableColumn
          [pSortableColumn]="col.field"
          *ngFor="let col of columns; let i = index"
          [ngStyle]="col.dynamicWidth ? { width: '225px' } : {}"
        >
          <div>
            <p class="table-header-text">{{ col.header }}</p>
            <p-sortIcon *ngIf="col.isSort" [field]="col.field"></p-sortIcon>
          </div>
        </th>
      </tr>

      <ng-container
        *ngIf="
          tabFilterItems[tabFilterIdx]?.value ===
            globalFeedbackConfig.types.transactional;
          else stayTableSearch
        "
      >
        <tr class="table-search-head">
          <th class="table-search-head"></th>
          <th class="table-search-head">
            <input
              pInputText
              type="text"
              (input)="
                onFilterTypeTextChange($event.target.value, 'tableOrRoomNumber')
              "
              class="p-column-filter"
            />
          </th>
          <th class="table-search-head">
            <input
              pInputText
              type="text"
              (input)="
                onFilterTypeTextChange($event.target.value, 'guest.fullName')
              "
              class="p-column-filter"
            />
          </th>
          <th class="table-search-head">
            <input
              pInputText
              type="text"
              (input)="
                onFilterTypeTextChange(
                  $event.target.value,
                  'booking.bookingNumber'
                )
              "
              class="p-column-filter"
            />
          </th>
          <th class="table-search-head">
            <input
              pInputText
              type="text"
              (input)="
                onFilterTypeTextChange($event.target.value, 'guest.place')
              "
              class="p-column-filter"
            />
          </th>
          <th class="table-search-head">
            <input
              pInputText
              type="text"
              (input)="onFilterTypeTextChange($event.target.value, 'vin')"
              class="p-column-filter"
              disabled="true"
            />
          </th>
          <th class="table-search-head">
            <input
              pInputText
              type="text"
              (input)="onFilterTypeTextChange($event.target.value, 'vin')"
              class="p-column-filter"
              disabled="true"
            />
          </th>
          <th class="table-search-head">
            <input
              pInputText
              type="text"
              (input)="onFilterTypeTextChange($event.target.value, 'vin')"
              class="p-column-filter"
              disabled="true"
            />
          </th>
        </tr>
      </ng-container>
      <ng-template #stayTableSearch>
        <tr>
          <th
            class="table-search-head"
            id="select-box"
            *ngIf="isSelectable"
          ></th>
          <th
            [id]="col.field"
            class="table-search-head"
            *ngFor="let col of columns"
          >
            <input
              pInputText
              type="text"
              (input)="onFilterTypeTextChange($event.target.value, col.field)"
              class="p-column-filter"
              [disabled]="col.isSearchDisabled"
            />
          </th>
        </tr>
      </ng-template>
    </ng-template>
    <!-- **************************************BODY********************************* -->
    <ng-template
      pTemplate="body"
      let-rowData
      let-columns="columns"
      let-rowIndex="rowIndex"
    >
      <ng-container
        *ngIf="
          tabFilterItems[tabFilterIdx]?.value ===
            globalFeedbackConfig.types.transactional;
          else stayTable
        "
      >
        <tr
          class="data-table-row"
          [style.background]="rowData?.read ? '' : 'rgba(174, 209, 251, .1)'"
        >
          <!-- <tr class="data-table-row"> -->
          <td class="table--checkbox">
            <p-tableCheckbox
              [value]="rowData"
              [index]="rowIndex"
              (click)="onCheckboxClicked($event)"
            >
            </p-tableCheckbox>
          </td>
          <td class="guest">
            <div class="guest-status" *ngIf="rowData?.timeOut">
              <img src="assets/svg/timeout.svg" alt="timeout" />
            </div>
            <div class="guest-name">
              {{ rowData?.bookingDetails.tableOrRoomNumber }}
            </div>
            <div class="guest-phone">{{ rowData?.outlet }}</div>
          </td>
          <td class="guest">
            <div class="guest-name">{{ rowData?.guest.getFullName() }}</div>
            <div class="guest-phone">{{ rowData?.guest.getPhoneNumber() }}</div>
          </td>
          <td class="service-feedback">
            <div class="feedback">
              <ng-container *ngIf="rowData?.services.services?.length > 0">
                <div
                  class="feedback-service"
                  *ngIf="
                    getRowDataNegativeServices(rowData).length > 0;
                    else noNegativeFeedback
                  "
                >
                  <div class="feedback-service__container">
                    <div class="feedback-service__container__label others">
                      <div class="feedback-service__container__label__text">
                        Overall
                      </div>
                    </div>
                    <div
                      *ngIf="rowData?.services?.rating?.value"
                      class="stay-booking-feedback"
                      [ngClass]="{
                        'status-opacity-reject':
                          rowData?.services.rating.value < 5,
                        'status-opacity-success':
                          rowData?.services.rating.value >= 5
                      }"
                    >
                      <p
                        class="number"
                        [ngClass]="{
                          'status-background-reject':
                            rowData?.services.rating.value < 5,
                          'status-background-moderate':
                            rowData?.services.rating.value >= 5 &&
                            rowData?.services.rating.value < 9,
                          'status-background-success':
                            rowData?.services.rating.value > 8
                        }"
                        *ngIf="rowData?.services.rating.value"
                      >
                        {{ rowData?.services.rating.value }}
                      </p>
                    </div>
                  </div>
                  <ng-container
                    *ngFor="
                      let service of rowData?.services.getNegativeRatedService();
                      let i = index
                    "
                  >
                    <div class="feedback-service__container" *ngIf="i < 2">
                      <div class="feedback-service__container__label">
                        <div class="feedback-service__container__label__text">
                          {{ service.serviceName | titlecase }}
                        </div>
                      </div>
                      <div
                        class="stay-booking-feedback"
                        [ngClass]="{
                          'status-opacity-reject': service.rating === 'EI',
                          'status-opacity-success': service.rating >= 5
                        }"
                      >
                        <p
                          class="number"
                          [ngClass]="{
                            'status-background-reject': service.rating === 'EI',
                            'status-background-moderate':
                              service.rating === 'ME',
                            'status-background-success': service.rating === 'EE'
                          }"
                        >
                          {{ service.rating }}
                        </p>
                      </div>
                    </div>
                    <div
                      class="feedback-service__container"
                      *ngIf="
                        i === 1 &&
                        getRowDataNegativeServices(rowData).length >= 2
                      "
                    >
                      <div class="feedback-service__container__label others">
                        <div class="feedback-service__container__label__text">
                          Others
                        </div>
                        <div class="stay-booking-feedback">
                          <p class="number">
                            +{{ rowData?.services.services.length - 2 }}
                          </p>
                        </div>
                      </div>
                    </div>
                    <ng-container
                      *ngIf="
                        i === 0 &&
                        getRowDataNegativeServices(rowData).length === 1
                      "
                    >
                      <div class="feedback-service__container__label others">
                        <div class="feedback-service__container__label__text">
                          Others
                        </div>
                        <div class="stay-booking-feedback">
                          <p class="number">
                            +{{ rowData?.services.services.length - 1 }}
                          </p>
                        </div>
                      </div>
                    </ng-container>
                  </ng-container>
                </div>
                <ng-template #noNegativeFeedback>
                  <div class="feedback-service">
                    <div class="feedback-service__container">
                      <div class="feedback-service__container__label others">
                        <div class="feedback-service__container__label__text">
                          Overall
                        </div>
                        <div class="stay-booking-feedback">
                          <p class="number">
                            +{{ rowData?.services.services.length }}
                          </p>
                        </div>
                      </div>
                      <div
                        *ngIf="rowData?.services?.rating?.value"
                        class="stay-booking-feedback"
                        [ngClass]="{
                          'status-opacity-reject':
                            rowData?.services.rating.value < 5,
                          'status-opacity-success':
                            rowData?.services.rating.value >= 5
                        }"
                      >
                        <p
                          class="number"
                          [ngClass]="{
                            'status-background-reject':
                              rowData?.services.rating.value < 5,
                            'status-background-moderate':
                              rowData?.services.rating.value >= 5 &&
                              rowData?.services.rating.value < 9,
                            'status-background-success':
                              rowData?.services.rating.value > 8
                          }"
                          *ngIf="rowData?.services.rating.value"
                        >
                          {{ rowData?.services.rating.value }}
                        </p>
                      </div>
                    </div>
                  </div>
                </ng-template>
              </ng-container>
              <div class="pdf">
                <img
                  [src]="globalFeedbackConfig.images.datatable.pdf.url"
                  [alt]="globalFeedbackConfig.images.datatable.pdf.alt"
                  (click)="downloadFeedbackPdf($event, rowData?.id)"
                />
              </div>
            </div>
          </td>
          <td class="package">
            <div class="package-date">
              {{ rowData?.getCreatedDate(globalFilterService.timezone) }}
            </div>
            <div class="package-date">
              {{ rowData?.getCreatedTime(globalFilterService.timezone) }}
            </div>
          </td>
          <td class="comments">{{ rowData?.guestData.overAllNps }}</td>
          <td class="comments">{{ rowData?.guestData.churnProbalilty }}</td>
          <td class="status-image" (click)="$event.stopPropagation()">
            <ng-container *ngIf="rowData.status === 'NOACTION'; else dropDown">
              <div class="detailPage" (click)="openDetailPage($event, rowData)">
                View Detail
              </div>
            </ng-container>
            <ng-template #dropDown>
              <hospitality-bot-action-overlay
                [rowDataStatus]="rowData?.status"
                [guestId]="rowData?.departmentId"
                [feedbackType]="tabFilterItems[tabFilterIdx]?.value"
                [departmentName]="rowData?.departmentName"
                [userPermissions]="userPermissions"
                (openDetail)="openDetailPage($event, rowData)"
                (statusUpdate)="updateFeedbackState($event)"
              ></hospitality-bot-action-overlay>
            </ng-template>
          </td>
        </tr>
      </ng-container>
      <ng-template #stayTable>
        <tr
          (click)="openDetailPage($event, rowData)"
          class="data-table-row"
          [style.background]="rowData?.read ? '' : 'rgba(174, 209, 251, .1)'"
        >
          <!-- <tr class="data-table-row"> -->
          <td class="table--checkbox">
            <p-tableCheckbox
              [value]="rowData"
              [index]="rowIndex"
              (click)="onCheckboxClicked($event)"
            >
            </p-tableCheckbox>
          </td>
          <td class="guest">
            <div class="guest-status" *ngIf="rowData?.timeOut">
              <img src="assets/svg/timeout.svg" alt="timeout" />
            </div>
            <div>{{ rowData?.tableOrRoomNumber }}</div>
          </td>
          <td class="service-feedback">
            <div class="feedback">
              <ng-container
                *ngIf="
                  getRowDataNegativeServices(rowData).length > 0;
                  else noNegativeFeedback
                "
              >
                <div class="feedback-service">
                  <div class="feedback-service__container">
                    <div class="feedback-service__container__label others">
                      <div class="feedback-service__container__label__text">
                        Overall
                      </div>
                      <!-- <div class="stay-booking-feedback">
                        <p class="number">+{{ rowData?.services.length }}</p>
                      </div> -->
                    </div>
                    <div class="stay-booking-feedback status-opacity-success">
                      <p
                        class="number status-background-success"
                        [style.background]="
                          (colorMap?.stayFeedbacks)[rowData?.ratings].colorCode
                        "
                        *ngIf="rowData?.ratings"
                      >
                        {{ rowData?.ratings }}
                      </p>
                    </div>
                  </div>
                  <ng-container
                    *ngFor="
                      let service of rowData?.getNegativeRatedService();
                      let i = index
                    "
                  >
                    <div class="feedback-service__container" *ngIf="i < 2">
                      <div class="feedback-service__container__label others">
                        <div class="feedback-service__container__label__text">
                          {{ service.serviceName | titlecase }}
                        </div>
                      </div>
                      <div class="stay-booking-feedback status-opacity-success">
                        <p
                          class="number status-background-success"
                          [style.background]="service.colorCode"
                        >
                          {{ service.rating }}
                        </p>
                      </div>
                    </div>
                    <ng-container
                      *ngIf="
                        (i === 1 &&
                          (getRowDataNegativeServices(rowData).length === 2 ||
                            getRowDataNegativeServices(rowData).length >= 2)) ||
                        (getRowDataNegativeServices(rowData).length === 1 &&
                          i === 0)
                      "
                    >
                      <div class="feedback-service__container__label others">
                        <div class="feedback-service__container__label__text">
                          Others
                        </div>
                        <div class="stay-booking-feedback">
                          <p class="number">
                            +{{
                              rowData?.services.length -
                                (getRowDataNegativeServices(rowData).length < 2
                                  ? getRowDataNegativeServices(rowData).length
                                  : 2)
                            }}
                          </p>
                        </div>
                      </div>
                    </ng-container>
                  </ng-container>
                </div>
              </ng-container>

              <ng-template #noNegativeFeedback>
                <div class="feedback-service">
                  <div class="feedback-service__container">
                    <div class="feedback-service__container__label others">
                      <div class="feedback-service__container__label__text">
                        Overall
                      </div>
                      <div class="stay-booking-feedback">
                        <p class="number">+{{ rowData?.services.length }}</p>
                      </div>
                    </div>
                    <div class="stay-booking-feedback status-opacity-success">
                      <p
                        class="number status-background-success"
                        [style.background]="
                          (colorMap?.stayFeedbacks)[rowData?.ratings].colorCode
                        "
                        *ngIf="rowData?.ratings"
                      >
                        {{ rowData?.ratings }}
                      </p>
                    </div>
                  </div>
                </div>
              </ng-template>
              <div class="pdf">
                <img
                  [src]="globalFeedbackConfig.images.datatable.pdf.url"
                  [alt]="globalFeedbackConfig.images.datatable.pdf.alt"
                  (click)="downloadFeedbackPdf($event, rowData?.id)"
                />
              </div>
            </div>
          </td>
          <td class="guest">
            <div class="guest-name">{{ rowData?.guest.getFullName() }}</div>
            <div class="guest-phone">{{ rowData?.guest.getPhoneNumber() }}</div>
            <div class="guest-phone">{{ rowData?.guest.emailId }}</div>
          </td>
          <td class="package">
            <p class="arrival-date">
              {{ rowData?.getCreatedDate(globalFilterService.timezone) }}
            </p>
            <p class="arrival-time">
              {{ rowData?.getCreatedTime(globalFilterService.timezone) }}
            </p>
            <p class="arrival-time">{{ rowData?.guestData.guestCount }}G</p>
          </td>
          <td class="comments">{{ rowData?.guestData.overAllNps }}</td>
          <td class="comments">{{ rowData?.guestData.churnProbalilty }}</td>

          <!-- status-image-initiated -->
          <td class="status-image" (click)="$event.stopPropagation()">
            <ng-container *ngIf="rowData.status === 'NOACTION'; else dropDown">
              <div class="detailPage" (click)="openDetailPage($event, rowData)">
                View Detail
              </div>
            </ng-container>
            <ng-template #dropDown>
              <hospitality-bot-action-overlay
                [rowDataStatus]="rowData?.status"
                [guestId]="rowData?.departmentId"
                [feedbackType]="tabFilterItems[tabFilterIdx]?.value"
                [departmentName]="rowData?.departmentName"
                (openDetail)="openDetailPage($event, rowData)"
                (statusUpdate)="updateFeedbackState($event)"
                [userPermissions]="userPermissions"
              ></hospitality-bot-action-overlay>
            </ng-template>
          </td>
        </tr>
      </ng-template>
    </ng-template>
    <!-- *********************************FOOTER******************************* -->
    <ng-template pTemplate="summary">
      <p-paginator
        #paginator
        [rows]="rowsPerPage"
        [totalRecords]="totalRecords"
        [rowsPerPageOptions]="rowsPerPageOptions"
        (onPageChange)="paginate($event)"
      ></p-paginator>
    </ng-template>
  </p-table>

  <ng-template #emptyCell>
    <div class="emptyCell">&mdash;</div>
  </ng-template>
</ng-template>
