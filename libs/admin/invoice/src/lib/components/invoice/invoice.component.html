<div class="wrapper">
  <hospitality-bot-navigation-header [heading]="pageTitle" [routes]="navRoutes">
    
    <hospitality-bot-button
      *ngIf="isGenerated"
      variant="text"
      label="Download PDF"
      (onClick)="handleDownload()"
    ></hospitality-bot-button>

    <hospitality-bot-button
      variant="outlined"
      label="Preview"
      [routerLink]="['../../preview-invoice', reservationId]" 
      queryParamsHandling="preserve"
    ></hospitality-bot-button>

    <hospitality-bot-button 
      [label]="isGenerated ? 'Email Invoice' : 'Generate'"
      (onClick)="handleGenerate()"
    ></hospitality-bot-button>
    
  </hospitality-bot-navigation-header>

  <div class="form-wrapper" [formGroup]="useForm">
    <div class="form-block">
      <div class="half-width">
        <span class="code__label"> Invoice Number: </span>
        <span class="code__hash">
          {{ inputControl.invoiceNumber.value }}
        </span>
      </div>
      <div class="half-width code__right">
        <span class="code__label"> Confirmation Number: </span>
        <span class="code__hash">
          {{ inputControl.confirmationNumber.value }}
        </span>
      </div>
      <hospitality-bot-input
        class="half-width"
        controlName="guestName"
        label="Guest Name"
        maxLength="60"
      ></hospitality-bot-input>
      <hospitality-bot-input
        class="half-width"
        controlName="companyName"
        label="Bill to individual/company"
        maxLength="60"
      ></hospitality-bot-input>
      <div *ngIf="isAddingGST" class="line full-width"></div>
      <hospitality-bot-button
        variant="text"
        [severity]="isAddingGST ? 'reset' : 'primary'"
        [label]="isAddingGST ? 'Remove' : 'Add GST/Bill to company'"
        (onClick)="onAddGST()"
        class="gst-btn"
      ></hospitality-bot-button>

      <div class="two-third-width"></div>
      <ng-container *ngIf="isAddingGST">
        <hospitality-bot-input
          class="one-third-width"
          controlName="gstNumber"
          label="GST Number"
          [props]="{ placeholder: 'Enter' }"            
        ></hospitality-bot-input>     
        <hospitality-bot-input
          class="one-third-width"
          controlName="contactName"
          label="Contact Name"
          [props]="{ placeholder: 'Enter' }"            
        ></hospitality-bot-input>   
        <hospitality-bot-input
          class="one-third-width"
          controlName="contactNumber"
          label="Contact Number"
          [props]="{ placeholder: 'Enter' }"            
        ></hospitality-bot-input>  
        <hospitality-bot-input
          class="one-third-width"
          controlName="email"
          label="Email"
          [props]="{ placeholder: 'Enter' }"            
        ></hospitality-bot-input>   
        <hospitality-bot-input
          class="one-third-width"
          controlName="address"
          label="Address"
          [props]="{ placeholder: 'Enter' }"            
        ></hospitality-bot-input>   
        <hospitality-bot-input
          class="one-third-width"
          controlName="state"
          label="State"
          [props]="{ placeholder: 'Enter' }"            
        ></hospitality-bot-input>    
        <hospitality-bot-input
          class="one-third-width"
          controlName="city"
          label="City"
          [props]="{ placeholder: 'Enter' }"            
        ></hospitality-bot-input>   
        <hospitality-bot-input
          class="one-third-width"
          controlName="pin"
          label="Pin"
          [props]="{ placeholder: 'Enter' }"            
        ></hospitality-bot-input>   
      </ng-container>
    </div>

    <div class="payment-form">
      <div class="payment-form__header">
        <span>Payment Detail</span>
        <div
          *ngIf="selectedRows?.length"
          class="delete-icon"
          (click)="removeSelectedCharges()"
        >
          <img src="assets/svg/delete.svg" alt="delete" />
        </div>
      </div>
      <div class="payment-form__details" formArrayName="tableData">
        <p-table
          #dt
          [columns]="cols"
          [value]="tableValue"
          [(selection)]="selectedRows"
          (onRowSelect)="onRowSelect($event)"
          (onRowUnselect)="onRowUnselect($event)"
          (onHeaderCheckboxToggle)="onToggleSelectAll($event)"
        >
          <ng-template pTemplate="header" let-columns #header>
            <tr class="header">
              <th id="select-all" class="select-box">
                <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
              </th>
              <th
                *ngFor="let col of columns"
                [id]="col.header"
                [ngStyle]="{ width: col.width }"
              >
                <div class="col-heading">{{ col.header }}</div>
              </th>
            </tr>
          </ng-template>
          <ng-template
            pTemplate="body"
            let-rowData
            let-columns="columns"
            let-rowIndex="rowIndex"
          >
            <tr [formGroupName]="rowIndex"
               [disabled]="true"
            >
              <td>
                <p-tableCheckbox
                  [value]="rowData"
                  [index]="rowIndex"
                  [disabled]="rowIndex===0"
                ></p-tableCheckbox>
              </td>
              <td>
                <hospitality-bot-select
                controlName="description"
                [props]="{ isAsync: true, isAutoFocusFilter: false }"
                [options]="serviceOptions"
                [stopEmission]="true"
                [loading]="loading"
                [disabled]="rowIndex===0"
              ></hospitality-bot-select>
              </td>
              <td>
                <hospitality-bot-input
                  controlName="unit"
                  [props]="{ type: 'number' }"
                  [disabled]="rowIndex===0"
                ></hospitality-bot-input>
              </td>
              <td>
                <hospitality-bot-input
                  controlName="unitValue"
                  [props]="{ type: 'number' }"
                  [disabled]="rowIndex===0"
                ></hospitality-bot-input>
              </td>
              <td>
                <hospitality-bot-input
                  controlName="amount"
                  [props]="{ type: 'number' }"
                  [disabled]="true"
                ></hospitality-bot-input>
              </td>
              <td>
                <hospitality-bot-multi-select
                  controlName="tax"
                  [options]="rowIndex === 0 ? defaultTax : tax"
                  [settings]="{ showHeader: false }"
                  [disabled]="true"
                ></hospitality-bot-multi-select>
              </td>
              <td>
                <hospitality-bot-input
                  controlName="totalAmount"
                  [props]="{ type: 'number' }"
                  [disabled]="true"
                ></hospitality-bot-input>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="summary">
            <hospitality-bot-button
              label="+ Add New"
              variant="text"
              (onClick)="addNewCharges()"
            ></hospitality-bot-button>
          </ng-template>
        </p-table>
      </div>

      <div class="payment-form__amount">
        <div class="py-row">
          <span>Current Amount</span>
          <span> INR {{ inputControl.currentAmount.value | number: '1.1-1' }}</span>
        </div>
        <div class="py-row stretch">
          <span>Discount</span>
          <span class="span-block">
            <span>INR {{ inputControl.totalDiscount.value | number: '1.1-1' }}</span>
            <ng-container *ngIf="viewDiscountTab">
              <span class="input-field discount-field">
                <hospitality-bot-prefix-field
                  [options]="discountOption"
                  preControlName="discountType"
                  postControlName="discount"
                  [props]="{ errorMessages: errorMessages, type: 'number' }"
                ></hospitality-bot-prefix-field>
              </span>
              <hospitality-bot-button
                label="Save"
                variant="text"
                (onClick)="onSaveDiscount()"
                [disabled]="!isValidDiscount"
              ></hospitality-bot-button>
            </ng-container>
            <hospitality-bot-menu
              *ngIf="!viewDiscountTab"
              type="button"
              alignment="horizontal"
              (onClickItem)="
                editMode ? onEditDiscount($event) : viewDiscountTab = true
              "
              [menuItems]="editMode ? editDiscount : addDiscount"
            ></hospitality-bot-menu>
          </span>
        </div>
        <div class="py-row invert">
          <span>Total Amount</span
          ><span>INR {{ inputControl.discountedAmount.value | number: '1.1-1' }}</span>
        </div>
        <div class="py-row stretch">
          <span>Paid Amount</span>
          <span class="span-block">
            <span>INR {{ inputControl.paidAmount.value | number: '1.1-1' }}</span>
            <ng-container *ngIf="viewPaidTab">
                <span class="input-field">
                  <hospitality-bot-input
                    controlName="paidValue"
                    [disabled]="true"
                  ></hospitality-bot-input>
                  <span> + </span>
                  <hospitality-bot-input
                    controlName="paid"
                    [props]="{ errorMessages: errorMessages, type: 'number' }"
                  ></hospitality-bot-input>
                </span>
                <hospitality-bot-button
                  label="Save"
                  variant="text"
                  (onClick)="onSavePaidAmount()"
                  [disabled]="!isValidPaid"
                ></hospitality-bot-button>
            </ng-container>
            <hospitality-bot-menu
              *ngIf="!viewPaidTab"
              type="button"
              alignment="horizontal"
              (onClickItem)="viewPaidTab = true"
              [menuItems]="editPaidAmount"
            ></hospitality-bot-menu>
          </span>
        </div>
        <div class="py-row">
          <span>Due Amount</span>
          <span>INR
            <span 
              [ngStyle]="{ color: inputControl.dueAmount.value < 0 ? 'red' : 'inherit' }"
              >{{ inputControl.dueAmount.value | number: '1.1-1' }}
          </span>
        </span>
        </div>
      </div>
      <div class="payment-form__note">
        <hospitality-bot-text-area
          controlName="additionalNote"
          label="Additional Note"
        ></hospitality-bot-text-area>
      </div>
    </div>

    <p-accordion class="form-accordion" [multiple]="true">
      <p-accordionTab header="Booking Information" [selected]="true">
        <div class="form-block">
          <hospitality-bot-input
            class="half-width"
            controlName="cashierName"
            label="Cashier Name"
            maxLength="60"
          ></hospitality-bot-input>
          <hospitality-bot-date
            class="half-width"
            controlName="invoiceDate"
            label="Invoice Date"
            [disabled]="isGenerated"
          ></hospitality-bot-date>
          <div class="payment-method">
            <hospitality-bot-select-group
              class="three-fourth"
              controlName="paymentMethod"
              label="Payment method"
              [options]="paymentOptions"
            ></hospitality-bot-select-group>
            <hospitality-bot-button
              variant="text"
              class="view-history-btn"
              label="View History"
              [routerLink]="['../../payment-history', reservationId]" 
              queryParamsHandling="preserve"
            ></hospitality-bot-button>
          </div>
          <hospitality-bot-input
            class="one-third-width"
            [props]="{
              placeholder: 'Enter'
            }"            
            controlName="recievedPayment"
            label="Payment Recieved"
          ></hospitality-bot-input>
          <hospitality-bot-input
            class="one-third-width"
            [props]="{ placeholder: 'Enter' }"
            controlName="remarks"
            label="Your Inclusions/remarks:"
          ></hospitality-bot-input>          
          <hospitality-bot-input
            class="one-third-width"
            [props]="{ placeholder: 'Enter' }"            
            controlName="transactionId"
            label="Transaction ID"
          ></hospitality-bot-input>
        </div>
      </p-accordionTab>
    </p-accordion>
    <div class="button">
      <hospitality-bot-button
        label="Save"
        (onClick)="handleSave()"
        [disabled]="isGenerated"
      ></hospitality-bot-button>
    </div>
  </div>
</div>


