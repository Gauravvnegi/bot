<div class="wrapper">
  <hospitality-bot-navigation-header [heading]="pageTitle" [routes]="navRoutes">
    <hospitality-bot-button
      variant="outlined"
      label="Preview and Generate"
      (onClick)="previewAndGenerate()"
      queryParamsHandling="preserve"
    ></hospitality-bot-button>
  </hospitality-bot-navigation-header>
  <div class="form-wrapper" [formGroup]="useForm">
    <div class="form-block">
      <div class="half-width">
        <span class="code__label"> Invoice Number: </span>
        <span class="code__hash">
          {{ inputControl.invoiceNumber.value }}
        </span>
      </div>
      <div class="half-width code__right">
        <span class="code__label"> Confirmation Number: </span>
        <span class="code__hash">
          {{ bookingNumber }}
        </span>
      </div>
      <hospitality-bot-input
        class="half-width"
        controlName="guestName"
        label="Guest Name"
        maxLength="60"
      ></hospitality-bot-input>
      <hospitality-bot-input
        class="half-width"
        controlName="companyName"
        label="Company"
        maxLength="60"
      ></hospitality-bot-input>
    </div>

    <div class="form-block">
      <div class="full-width header">
        <div class="header">GST Details</div>
        <hospitality-bot-button
          variant="text"
          [severity]="addGST ? 'reset' : 'primary'"
          [label]="addGST ? 'Remove GST' : '+Add GST'"
          (onClick)="onAddGST()"
          [disabled]="isInvoiceGenerated"
        ></hospitality-bot-button>
      </div>

      <ng-container *ngIf="addGST">
        <hospitality-bot-input
          class="one-third-width"
          controlName="gstNumber"
          label="GST Number"
          [props]="{ placeholder: 'Enter' }"
        ></hospitality-bot-input>
        <!-- <hospitality-bot-input
          class="one-third-width"
          controlName="contactName"
          label="Contact Name"
          [props]="{ placeholder: 'Enter' }"
        ></hospitality-bot-input>
        <hospitality-bot-input
          class="one-third-width"
          controlName="contactNumber"
          label="Contact Number"
          [props]="{ placeholder: 'Enter' }"
        ></hospitality-bot-input> -->
        <hospitality-bot-input
          class="one-third-width"
          controlName="email"
          label="Email"
          [props]="{ placeholder: 'Enter' }"
        ></hospitality-bot-input>
        <hospitality-bot-input
          class="one-third-width"
          controlName="address"
          label="Address"
          [props]="{ placeholder: 'Enter' }"
        ></hospitality-bot-input>
        <hospitality-bot-input
          class="one-third-width"
          controlName="state"
          label="State"
          [props]="{ placeholder: 'Enter' }"
        ></hospitality-bot-input>
        <hospitality-bot-input
          class="one-third-width"
          controlName="city"
          label="City"
          [props]="{ placeholder: 'Enter' }"
        ></hospitality-bot-input>
        <hospitality-bot-input
          class="one-third-width"
          controlName="pin"
          label="Pin"
          [props]="{ placeholder: 'Enter' }"
        ></hospitality-bot-input>
      </ng-container>
    </div>

    <div class="payment-form">
      <div class="payment-form__header">
        <span>Payment Detail</span>
        <div
          *ngIf="selectedRows?.length"
          class="delete-icon"
          (click)="removeSelectedCharges()"
        >
          <img src="assets/svg/delete.svg" alt="delete" />
        </div>
      </div>
      <div class="payment-form__details" formArrayName="tableData">
        <p-table
          #dt
          [columns]="cols"
          [value]="tableValue"
          [(selection)]="selectedRows"
          [loading]="loadingData"
          (onRowSelect)="onRowSelect($event)"
          (onRowUnselect)="onRowUnselect($event)"
          (onHeaderCheckboxToggle)="onToggleSelectAll($event)"
        >
          <ng-template pTemplate="header" let-columns #header>
            <tr class="header">
              <th id="select-all" class="select-box">
                <!-- <p-tableHeaderCheckbox></p-tableHeaderCheckbox> -->
              </th>
              <th
                *ngFor="let col of columns"
                [id]="col.header"
                [ngStyle]="{ width: col.width }"
              >
                <div class="col-heading">{{ col.header }}</div>
              </th>
            </tr>
          </ng-template>
          <ng-template
            pTemplate="body"
            let-rowData
            let-columns="columns"
            let-rowIndex="rowIndex"
          >
            <tr [formGroupName]="rowIndex" [disabled]="true">
              <td>
                <p-tableCheckbox
                  [value]="tableFormArray.at(rowIndex)?.get('itemId').value"
                  [index]="rowIndex"
                  [disabled]="
                    tableFormArray.at(rowIndex).get('isDisabled').value ||
                    tableFormArray.at(rowIndex).get('isDiscount').value ||
                    tableFormArray.at(rowIndex).get('taxId').value
                  "
                ></p-tableCheckbox>
              </td>

              <td>
                <hospitality-bot-date
                  [settings]="{
                    enableTime: false
                  }"
                  controlName="date"
                  [minDate]="currentData"
                  [disabled]="true"
                ></hospitality-bot-date>
              </td>
              <td>
                <hospitality-bot-select
                  class="bill-description"
                  controlName="billItemId"
                  [options]="
                    rowIndex !== selectedSearchIndex
                      ? defaultDescriptionOptions
                      : filteredDescriptionOptions
                  "
                  [props]="{
                    isAsync: true,
                    createPrompt: '+ Add New Service',
                    placeholder: 'Select'
                  }"
                  [loading]="
                    rowIndex === selectedSearchIndex && loadingDescription
                  "
                  (paginate)="loadMoreDescription()"
                  (onSearch)="searchDescription($event)"
                  [stopEmission]="noMoreDescription"
                  (onCreate)="createService($event)"
                  [disabled]="
                    tableFormArray.at(rowIndex).get('isDisabled').value ||
                    tableFormArray.at(rowIndex).get('isDiscount').value ||
                    !tableFormArray.at(rowIndex).get('isNew').value
                  "
                  (onFocus)="handleFocus(rowIndex)"
                  (onBlur)="handleBlur()"
                ></hospitality-bot-select>
              </td>

              <td>
                <hospitality-bot-input
                  controlName="unit"
                  [props]="{
                    errorMessages: errorMessages,
                    type: 'number'
                  }"
                  [disabled]="
                    tableFormArray.at(rowIndex).get('isDisabled').value ||
                    tableFormArray.at(rowIndex).get('isDiscount').value ||
                    tableFormArray.at(rowIndex).get('isRefund').value
                  "
                ></hospitality-bot-input>
                <!-- <hospitality-bot-input-number
                  controlName="unit"
                  [disabled]="
                    tableFormArray.at(rowIndex).get('isDisabled').value ||
                    tableFormArray.at(rowIndex).get('isDiscount').value ||
                    tableFormArray.at(rowIndex).get('isRefund').value
                  "
                  [settings]="{
                    min: 1
                  }"
                >
                </hospitality-bot-input-number> -->
              </td>

              <td>
                <hospitality-bot-input
                  controlName="debitAmount"
                  [props]="{ type: 'number' }"
                  [disabled]="true"
                ></hospitality-bot-input>
              </td>

              <td>
                <hospitality-bot-input
                  controlName="creditAmount"
                  [props]="{ type: 'number' }"
                  [disabled]="true"
                ></hospitality-bot-input>
              </td>

              <td>
                <hospitality-bot-menu
                  type="button"
                  alignment="horizontal"
                  (onClickItem)="handleDiscount($event, rowIndex)"
                  [menuItems]="
                    hasDiscount(tableFormArray.at(rowIndex).get('itemId').value)
                      ? editDiscountMenu
                      : addDiscountMenu
                  "
                  [disabled]="
                    isInvoiceGenerated ||
                    !(
                      tableFormArray.at(rowIndex).get('itemId').value &&
                      (!tableFormArray.at(rowIndex).get('taxId').value ||
                        tableFormArray.at(rowIndex).get('isDiscount').value)
                    )
                  "
                ></hospitality-bot-menu>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="summary">
            <div class="summary-btn">
              <hospitality-bot-button
                label="+ Add New Item"
                variant="text"
                (onClick)="addNewCharges()"
                [disabled]="isInvoiceGenerated"
              ></hospitality-bot-button>
              <hospitality-bot-button
                *ngIf="inputControl.dueAmount.value < 0"
                label="+ Add Refund"
                variant="text"
                [severity]="'reset'"
                (onClick)="handleRefund()"
                [disabled]="isInvoiceGenerated"
              ></hospitality-bot-button>
            </div>
          </ng-template>
        </p-table>
      </div>

      <div class="payment-form__amount">
        <div class="py-row">
          <span>Net Amount</span>
          <span>
            INR {{ inputControl.totalAmount.value | number: '1.1-1' }}</span
          >
        </div>
        <div class="py-row invert">
          <span>Paid Amount</span>
          <span>
            <span
              >INR
              {{ inputControl.paidAmount.value | number: '1.1-1' }}
            </span>
          </span>
        </div>

        <div class="py-row">
          <span>Due Amount</span>
          <span
            [ngStyle]="{
              color: inputControl.dueAmount.value < 0 ? 'red' : 'inherit'
            }"
            >INR
            <span>{{ inputControl.dueAmount.value | number: '1.1-1' }} </span>
          </span>
        </div>
      </div>
      <div class="payment-form__note">
        <hospitality-bot-text-area
          controlName="additionalNote"
          label="Additional Note"
        ></hospitality-bot-text-area>
      </div>
    </div>

    <div class="form-block">
      <div class="full-width header">
        <div class="header">
          Payment Details
        </div>
        <hospitality-bot-button
          variant="text"
          [severity]="addPayment ? 'reset' : 'primary'"
          [label]="addPayment ? 'Remove Payment' : '+Add Payment'"
          [disabled]="isInvoiceGenerated"
          (onClick)="onAddPaymentDetails()"
        ></hospitality-bot-button>
      </div>

      <ng-container *ngIf="addPayment">
        <hospitality-bot-input
          class="half-width"
          controlName="cashierName"
          label="Cashier Name"
          maxLength="60"
        ></hospitality-bot-input>
        <hospitality-bot-input
          class="half-width"
          controlName="remarks"
          [props]="{
            placeholder: 'Enter'
          }"
          label="Your Inclusions/remarks:"
        ></hospitality-bot-input>
        <hospitality-bot-select-group
          class="full-width"
          controlName="paymentMethod"
          label="Payment method"
          [options]="paymentOptions"
        ></hospitality-bot-select-group>
        <!-- <div class="one-third-width"></div> -->
        <hospitality-bot-input
          class="half-width"
          controlName="receivedPayment"
          [props]="{
            placeholder: 'Enter',
            type: 'number',
            errorMessages: {
              required: 'This is a required field.',
              min: 'Value must be greater than 0.'
            }
          }"
          label="Payment Recieved"
        ></hospitality-bot-input>

        <hospitality-bot-input
          class="half-width"
          controlName="transactionId"
          [props]="{
            placeholder: 'Enter'
          }"
          label="Transaction ID"
        ></hospitality-bot-input>
      </ng-container>
    </div>

    <div class="button">
      <hospitality-bot-button
        label="Save Details"
        (onClick)="handleSave()"
        [disabled]="isInvoiceGenerated"
      ></hospitality-bot-button>
    </div>
  </div>
</div>
