<div [ngClass]="{ 'details-wrapper': !isFirstTimeFetch }">
  <div class="header">
    <div (click)="closeDetails()" class="close">
      <i class="fa fa-times" aria-hidden="true"></i>
    </div>
    <div class="name-details" *ngIf="isGuestInfoPatched">
      <div class="name-details-wrapper">
        <div class="profile-pic"></div>
        <div class="details">
          <div class="name">
            <span>{{ guestData.getFullName() }}</span>
            <div class="vip-image" *ngIf="guestData.vip">
              <img src="assets/images/VIP.png" />
            </div>
          </div>
          <div class="contact-details" *ngIf="isGuestInfoPatched">
            <a
              href="tel:{{ guestData.countryCode }}{{ guestData.phoneNumber }}"
              *ngIf="guestData.phoneNumber"
              class="call"
            >
              <mat-icon class="material-icons" matSuffix>call</mat-icon>
              <u>{{ guestData.countryCode }} {{ guestData.phoneNumber }}</u>
            </a>
          </div>
          <div class="contact-details" *ngIf="isGuestInfoPatched">
            <a
              href="mailto:{{ guestData.email }}"
              *ngIf="guestData.email"
              class="email"
            >
              <mat-icon class="material-icons" matSuffix>email</mat-icon>
              <u>{{ guestData.email }}</u>
            </a>
          </div>
        </div>
      </div>
      <div class="header-seperator"></div>
      <div class="guest_data">
        <div class="guest_data__field">
          <div class="label">
            {{
              guestData.guestAttributes.overAllNps !== 0
                ? guestData.guestAttributes.overAllNps
                : '-'
            }}/10
          </div>
          <div class="value">Overall NPS</div>
        </div>
        <!-- <div class="guest_data__field">
          <div class="label">
            {{ guestData.guestAttributes.churnProbalilty }}
          </div>
          <div class="value">Churn Probability</div>
        </div> -->
        <div class="guest_data__field">
          <div class="label">{{ guestData.guestAttributes.totalSpend }}</div>
          <div class="value">Overall Spent</div>
        </div>
        <div class="guest_data__field">
          <div class="label">{{ bookingCount }}</div>
          <div class="value">Bookings</div>
        </div>
      </div>
    </div>
    <hr />

    <div
      class="options-wrapper"
      *ngIf="isGuestInfoPatched && guestReservationDropdownList.length"
    >
      <div *ngIf="isGuestReservationFetched" [formGroup]="bookingFG">
        <mat-select
          class="past-booking"
          formControlName="booking"
          (selectionChange)="handleBookingChange($event)"
        >
          <mat-option
            [value]="item.bookingId"
            *ngFor="let item of guestReservationDropdownList"
            >{{ item.label | titlecase }} - {{ item.bookingNumber }}</mat-option
          >
        </mat-select>
      </div>
      <div class="btn-wrapper">
        <button
          class="check-button"
          (click)="downloadRegcard(details.guestDetails.guests[0].regcardUrl)"
        >
          <img src="assets/svg/Layer_d.svg" alt="Download" srcset="" /> &nbsp;
          &nbsp;
          <p class="text">Reg card</p>
          <ng-container
            [ngSwitch]="
              details.guestDetails.guests[0] &&
              details.guestDetails.guests[0].regcardStatus
            "
          >
            <mat-icon
              *ngSwitchCase="'COMPLETED'"
              class="material-icons"
              matSuffix
              >check_circle</mat-icon
            >
            <mat-icon *ngSwitchDefault class="material-icons" matSuffix
              >help</mat-icon
            >
          </ng-container>
        </button>
        <button
          (click)="downloadHealthcard(details.healDeclarationDetails.url)"
          class="check-button"
        >
          <img src="assets/svg/Layer_d.svg" alt="Download" srcset="" /> &nbsp;
          &nbsp;
          <p class="text">Health Declaration</p>
          <ng-container [ngSwitch]="healthCardDetailsFG.get('status').value">
            <mat-icon
              *ngSwitchCase="'COMPLETED'"
              class="material-icons"
              matSuffix
              >check_circle</mat-icon
            >

            <mat-icon *ngSwitchCase="'FAILED'" class="material-icons" matSuffix
              >disabled_by_default</mat-icon
            >

            <mat-icon *ngSwitchCase="'PENDING'" class="material-icons" matSuffix
              >help</mat-icon
            >

            <mat-icon
              *ngSwitchCase="'INITIATED'"
              class="material-icons"
              matSuffix
              >help</mat-icon
            >
          </ng-container>
        </button>
      </div>
    </div>
    <div
      class="flxExt"
      *ngIf="isGuestInfoPatched && guestReservationDropdownList.length"
    >
      <div class="flx">
        <div class="svg-wrapper">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="37.862"
            viewBox="0 0 16 37.862"
            class="svg"
          >
            <g id="standing-up-man-" transform="translate(-15.459)">
              <g
                id="Group_4959"
                data-name="Group 4959"
                transform="translate(15.459 0)"
              >
                <circle
                  id="Ellipse_721"
                  data-name="Ellipse 721"
                  cx="3.187"
                  cy="3.187"
                  r="3.187"
                  transform="translate(4.752)"
                  fill="#fff"
                />
                <path
                  id="Path_2154"
                  data-name="Path 2154"
                  d="M24.508,11.115a5.8,5.8,0,0,0-2.437.03c-5.3.621-7.019,6.754-6.533,11.43.211,2.022,3.4,2.043,3.185,0a12.138,12.138,0,0,1,.8-6.1v6.664c0,.078.008.152.011.228,0,.036-.011.066-.011.1,0,5.288-.009,10.575-.228,15.859-.1,2.349,3.545,2.34,3.642,0,.171-4.142.214-8.285.224-12.429a4.214,4.214,0,0,0,.518,0c.011,4.144.052,8.288.222,12.428.1,2.34,3.739,2.349,3.642,0-.218-5.284-.226-10.571-.226-15.859a2,2,0,0,0-.055-.457c0-2.3-.093-4.594-.066-6.889,1.085,1.836,1.184,4.637,1,6.452-.214,2.041,2.974,2.021,3.185,0C31.877,17.8,30.074,11.509,24.508,11.115Z"
                  transform="translate(-15.459 -3.222)"
                  fill="#fff"
                />
              </g>
            </g>
          </svg>
          <span *ngIf="stayDetailsFG.get('adultsCount')">{{
            stayDetailsFG.get('adultsCount').value
          }}</span>
        </div>
        <div class="svg-wrapper">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="12.96"
            height="23.764"
            viewBox="0 0 12.96 23.764"
            class="svg"
          >
            <g id="children" transform="translate(-148.54 -15.636)">
              <path
                id="Path_2151"
                data-name="Path 2151"
                d="M161.047,41.995a1.023,1.023,0,0,0-1.42.279l-2.816,4.194a2.29,2.29,0,0,0-1.027-.242h-1.535a2.292,2.292,0,0,0-1.022.239l-2.815-4.191a1.023,1.023,0,1,0-1.7,1.141l3.25,4.84c-.024.2-.014,13.639-.014,13.639a1.279,1.279,0,0,0,2.558,0V56.138h1.023v5.756a1.279,1.279,0,0,0,2.558,0c0-4.943.006-13.412-.019-13.632l3.255-4.847A1.023,1.023,0,0,0,161.047,41.995Z"
                transform="translate(0 -23.773)"
                fill="#fff"
              />
              <path
                id="Path_2152"
                data-name="Path 2152"
                d="M194.71,21.738a2.451,2.451,0,0,0,1.336-4.507,2.56,2.56,0,0,1,.46-.242.232.232,0,0,0,.02-.42,2.025,2.025,0,0,0-1.306-.12,2.548,2.548,0,0,1,.293-.433.232.232,0,0,0-.181-.38,2.9,2.9,0,0,0-2.046,1.462,1.57,1.57,0,0,0-.14.3,2.451,2.451,0,0,0,1.563,4.34Z"
                transform="translate(-39.69)"
                fill="#fff"
              />
            </g>
          </svg>
          <span *ngIf="stayDetailsFG.get('kidsCount')">{{
            stayDetailsFG.get('kidsCount').value
          }}</span>
        </div>
        <div class="vip-image" *ngIf="guestData.vip">
          <img src="assets/images/VIP.png" />
        </div>
      </div>
    </div>
  </div>

  <div [ngClass]="{ 'details-wrapper': !isFirstTimeFetch }">
    <ng-container *ngIf="isReservationDetailFetched; else detailsLoader">
      <div class="mat-group">
        <mat-tab-group
          [selectedIndex]="tabIndex"
          (selectedTabChange)="setTab($event)"
        >
          <mat-tab label="Guest Details">
            <hospitality-bot-admin-guest-details
              *ngIf="isReservationDetailFetched"
              [parentForm]="detailsForm"
              [data]="details"
              (addFGEvent)="addFGEvent($event)"
              (isGuestInfoPatched)="guestInfoPatched($event)"
              [guestData]="guestData"
            ></hospitality-bot-admin-guest-details>
          </mat-tab>
          <mat-tab
            label="Documents"
            *ngIf="guestReservationDropdownList.length"
          >
            <hospitality-bot-admin-documents-details
              *ngIf="
                isReservationDetailFetched &&
                guestReservationDropdownList.length
              "
              #adminDocumentsDetailsComponent
              [parentForm]="detailsForm"
              [data]="details"
              (addFGEvent)="addFGEvent($event)"
            ></hospitality-bot-admin-documents-details>
          </mat-tab>
          <mat-tab [label]="getVisitDetaillabel()">
            <hospitality-bot-stay-details
              *ngIf="isReservationDetailFetched"
              #adminStayDetailsComponent
              [parentForm]="detailsForm"
              [data]="details"
              [guestReservations]="guestReservations.records"
              [bookingNumber]="bookingNumber"
              [colorMap]="colorMap"
              (addFGEvent)="addFGEvent($event)"
            ></hospitality-bot-stay-details>
          </mat-tab>
          <mat-tab label="Add-ons" *ngIf="guestReservationDropdownList.length">
            <hospitality-bot-admin-package-details
              *ngIf="isReservationDetailFetched"
              [parentForm]="detailsForm"
              [data]="details"
            ></hospitality-bot-admin-package-details>
          </mat-tab>
          <mat-tab label="Payment" *ngIf="guestReservationDropdownList.length">
            <hospitality-bot-admin-payment-details
              *ngIf="isReservationDetailFetched"
              [parentForm]="detailsForm"
              [data]="details"
              (addFGEvent)="addFGEvent($event)"
            ></hospitality-bot-admin-payment-details>
          </mat-tab>
          <mat-tab
            label="Activities"
            *ngIf="guestReservationDropdownList.length"
          >
            <hospitality-bot-requests-table
              *ngIf="isReservationDetailFetched"
              [parentForm]="detailsForm"
              [data]="details"
              [colorMap]="colorMap"
            ></hospitality-bot-requests-table>
          </mat-tab>
        </mat-tab-group>
        <div
          *ngIf="
            isReservationDetailFetched && guestReservationDropdownList.length
          "
          class="tab-buttons"
        >
          <div class="button-wrapper">
            <hospitality-bot-button
              *ngIf="!branchConfig.pmsEnable"
              [label]="'Manage Invoice'"
              (click)="manageInvoice()"
              variant="outlined"
            ></hospitality-bot-button>
            <ng-container [ngSwitch]="details.currentJourneyDetails.journey">
              <ng-container *ngSwitchCase="'PRECHECKIN'">
                <ng-container *ngTemplateOutlet="PRECHECKIN"></ng-container>
              </ng-container>
              <ng-container *ngSwitchCase="'CHECKIN'">
                <ng-container *ngTemplateOutlet="CHECKIN"></ng-container>
              </ng-container>
              <ng-container *ngSwitchCase="'CHECKOUT'">
                <ng-container *ngTemplateOutlet="CHECKOUT"></ng-container>
              </ng-container>
            </ng-container>
            <ng-template #PRECHECKIN>
              <ng-container [ngSwitch]="details.currentJourneyDetails.status">
                <ng-container *ngSwitchCase="'PENDING'">
                  <hospitality-bot-button
                    label="Activate & Generate PreCheckIn"
                    (click)="activateAndgenerateJourney('PRECHECKIN')"
                    variant="outlined"
                  ></hospitality-bot-button>
                </ng-container>
                <ng-container *ngSwitchCase="'INITIATED'">
                  <hospitality-bot-button
                    label="Activate & Generate PreCheckIn"
                    (click)="activateAndgenerateJourney('PRECHECKIN')"
                    variant="outlined"
                  ></hospitality-bot-button>
                </ng-container>
                <ng-container *ngSwitchCase="'COMPLETED'">
                  <hospitality-bot-button
                    label="Activate & Generate PreCheckIn"
                    (click)="activateAndgenerateJourney('PRECHECKIN')"
                    variant="outlined"
                  ></hospitality-bot-button>
                </ng-container>
                <ng-container *ngSwitchCase="'FAILED'">
                  <hospitality-bot-button
                    label="Activate & Generate PreCheckIn"
                    (click)="activateAndgenerateJourney('PRECHECKIN')"
                    variant="outlined"
                  ></hospitality-bot-button>
                </ng-container>
              </ng-container>
            </ng-template>
            <ng-template #CHECKIN>
              <ng-container [ngSwitch]="details.currentJourneyDetails.status">
                <ng-container *ngSwitchCase="'PENDING'">
                  <hospitality-bot-button
                    (click)="activateAndgenerateJourney('CHECKIN')"
                    label="Generate CheckIn"
                    variant="outlined"
                  ></hospitality-bot-button>
                </ng-container>
                <ng-container *ngSwitchCase="'INITIATED'">
                  <hospitality-bot-button
                    (click)="activateAndgenerateJourney('CHECKIN')"
                    label="Generate CheckIn"
                    variant="outlined"
                  ></hospitality-bot-button>
                  <hospitality-bot-button
                    (click)="verifyAllDocuments()"
                    label="Confirm All Docs"
                    variant="outlined"
                  ></hospitality-bot-button>
                  <!-- <hospitality-bot-button
                  (click)="downloadInvoice()"
                  label="Download Invoice/Folio"
                  variant="outlined"
                ></hospitality-bot-button> -->
                  <!-- ---------------------------------------------------------------------------------------------- -->
                  <hospitality-bot-button
                    (click)="confirmAndNotifyCheckin()"
                    label="Confirm And Notify Checkin"
                    variant="outlined"
                  ></hospitality-bot-button>
                </ng-container>
                <ng-container *ngSwitchCase="'COMPLETED'">
                  <!-- initiate force checkout -->
                  <!-- download invoice -->
                  <hospitality-bot-button
                    *ngIf="branchConfig.pmsEnable"
                    [label]="'Prepare Invoice'"
                    (click)="prepareInvoice()"
                    variant="outlined"
                  ></hospitality-bot-button>
                  <hospitality-bot-button
                    *ngIf="checkForGenerateFeedbackSubscribed()"
                    label="Generate Feedback"
                    (click)="generateFeedback('CHECKIN')"
                    variant="outlined"
                  ></hospitality-bot-button>
                </ng-container>
                <ng-container *ngSwitchCase="'FAILED'">
                  <hospitality-bot-button
                    label="Generate CheckIn"
                    (click)="activateAndgenerateJourney('CHECKIN')"
                    variant="outlined"
                  ></hospitality-bot-button>
                  <!-- <hospitality-bot-button
                  label="Download Invoice/Folio"
                  (click)="downloadInvoice()"
                  variant="outlined"
                ></hospitality-bot-button> -->
                </ng-container>
              </ng-container>
            </ng-template>
            <ng-template #CHECKOUT
              ><ng-container [ngSwitch]="details.currentJourneyDetails.status">
                <ng-container *ngSwitchCase="'PENDING'">
                  <ng-container
                    *ngIf="
                      details.invoicePrepareRequest;
                      else prepareInvoiceBtn
                    "
                  >
                    <hospitality-bot-button
                      label="Activate & Generate Checkout"
                      (click)="activateAndgenerateJourney('CHECKOUT')"
                      variant="outlined"
                    ></hospitality-bot-button>

                    <hospitality-bot-button
                      label="Download Invoice/Folio"
                      (click)="downloadInvoice()"
                      variant="outlined"
                    ></hospitality-bot-button>
                  </ng-container>
                  <ng-template #prepareInvoiceBtn>
                    <hospitality-bot-button
                      *ngIf="branchConfig.pmsEnable"
                      [label]="'Prepare Invoice'"
                      (click)="prepareInvoice()"
                      variant="outlined"
                    ></hospitality-bot-button>
                  </ng-template>
                </ng-container>
                <ng-container *ngSwitchCase="'INITIATED'">
                  <ng-container
                    *ngIf="
                      details.invoicePrepareRequest;
                      else prepareInvoiceBtn
                    "
                  >
                    <hospitality-bot-button
                      label="Activate & Generate Checkout"
                      (click)="activateAndgenerateJourney('CHECKOUT')"
                      variant="outlined"
                    ></hospitality-bot-button>

                    <hospitality-bot-button
                      *ngIf="branchConfig.pmsEnable"
                      label="Download Invoice/Folio"
                      (click)="downloadInvoice()"
                      variant="outlined"
                    ></hospitality-bot-button>
                  </ng-container>
                  <ng-template #prepareInvoiceBtn>
                    <hospitality-bot-button
                      *ngIf="branchConfig.pmsEnable"
                      [label]="'Prepare Invoice'"
                      (click)="prepareInvoice()"
                      variant="outlined"
                    ></hospitality-bot-button>
                  </ng-template>
                </ng-container>
                <ng-container *ngSwitchCase="'COMPLETED'">
                  <hospitality-bot-button
                    *ngIf="branchConfig.pmsEnable"
                    label="Download Invoice/Folio"
                    (click)="downloadInvoice()"
                    variant="outlined"
                  ></hospitality-bot-button>
                  <hospitality-bot-button
                    *ngIf="branchConfig.pmsEnable"
                    label="Send Invoice"
                    (click)="sendInvoice()"
                    variant="outlined"
                  ></hospitality-bot-button>
                </ng-container>
                <ng-container *ngSwitchCase="'FAILED'">
                  <hospitality-bot-button
                    label="Activate & Generate Checkout"
                    (click)="activateAndgenerateJourney('CHECKOUT')"
                    variant="outlined"
                  ></hospitality-bot-button>
                  <hospitality-bot-button
                    *ngIf="branchConfig.pmsEnable"
                    label="Download Invoice/Folio"
                    (click)="downloadInvoice()"
                    variant="outlined"
                  ></hospitality-bot-button>
                </ng-container>
              </ng-container>
            </ng-template>
          </div>
          <div *ngIf="channels.length>0">
            <p class="contact">Contact Guest</p>
            <div class="right-bottom-icons">
              <ng-container *ngFor="let channel of channels">
                <div
                  class="social-icons"
                  (click)="openSendNotification(channel.name)"
                  [style.display]="channel.isView ? 'flex' : 'none'"
                >
                  <div class="icon">
                    <img [src]="getIconUrl(channel)" />
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<ng-template #detailsLoader>
  <hospitality-bot-loader-bounce></hospitality-bot-loader-bounce>
</ng-template>
