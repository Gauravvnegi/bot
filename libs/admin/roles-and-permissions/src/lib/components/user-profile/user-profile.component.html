<hospitality-bot-navigation-header [heading]="pageTitle" [routes]="navRoutes">
</hospitality-bot-navigation-header>

<form class="wrapper" [formGroup]="userForm">
  <hospitality-bot-input
    class="third-width"
    controlName="firstName"
    label="First Name :"
  ></hospitality-bot-input>

  <hospitality-bot-input
    class="third-width"
    controlName="lastName"
    label="Last Name :"
  ></hospitality-bot-input>

  <hospitality-bot-multi-select
    class="third-width"
    controlName="products"
    [options]="products"
    label="Product Type :"
  ></hospitality-bot-multi-select>

  <hospitality-bot-multi-select
    class="full-width"
    controlName="departments"
    [options]="departments"
    label="Dept :"
  ></hospitality-bot-multi-select>

  <hospitality-bot-input
    class="third-width"
    controlName="jobTitle"
    label="Job Title :"
  ></hospitality-bot-input>

  <hospitality-bot-select
    class="third-width"
    controlName="branchName"
    [options]="branchNames"
    label="Hotel :"
  ></hospitality-bot-select>

  <hospitality-bot-prefix-field
    class="third-width phoneNo"
    [options]="countries"
    preControlName="cc"
    postControlName="phoneNumber"
    [defaultProps]="{ post: { type: 'string' } }"
    label="Phone# :"
  ></hospitality-bot-prefix-field>

  <hospitality-bot-select
    class="third-width"
    controlName="brandName"
    [options]="brandNames"
    label="Brand :"
  ></hospitality-bot-select>

  <hospitality-bot-input
    class="third-width"
    controlName="email"
    label="Email ID :"
    [props]="{
      errorMessages: {
        required: 'This is a required field.',
        pattern: 'Enter valid email address'
      }
    }"
  ></hospitality-bot-input>

  <ng-container *ngIf="hasPageState('view') && !!totalTeamMember">
    <div class="one-width">Team :</div>
    <div class="third-width">
      <div class="member">
        <div
          *ngFor="let item of teamMember; let index = index"
          (click)="openTableModal()"
        >
          <div
            class="member-name"
            [style.margin-left]="'calc(indexpx + 48px)'"
            *ngIf="index < 3"
            [style.background]="item.color"
          >
            {{ item.initial }}
          </div>
        </div>
      </div>
      <div *ngIf="totalTeamMember > 3" class="total-member">
        + {{ totalTeamMember - 3 }}
      </div>
    </div>
  </ng-container>
  <div
    *ngIf="!totalTeamMember"
    class="all-user two-third-width"
    (click)="openTableModal()"
  >
    View All Users
  </div>

  <!-- ****************Permission Wrapper**************** -->
  <div
    class="wrapper-manage-permission full-width"
    (click)="handleManage($event)"
  >
    <div class="header">
      <span *ngIf="hasPageState('add', 'edit')">
        Manage Permissions
      </span>
      <span *ngIf="hasPageState('view')">
        Permissions
      </span>
      <hospitality-bot-button
        label="+ Add New User"
        (click)="addUser()"
        *ngIf="hasPageState('view')"
      >
      </hospitality-bot-button>
    </div>

    <mat-accordion>
      <mat-expansion-panel
        (opened)="panelOpenState = true"
        (closed)="panelOpenState = false"
        expanded
      >
        <mat-expansion-panel-header>
          <mat-panel-title>
            <div *ngIf="userToModDetails?.products" class="tabs">
              <hospitality-bot-tab-group
                [listItems]="tabListItems"
                [selectedIndex]="tabIdx"
                (selectedTabChange)="onSelectedTabFilterChange($event)"
              ></hospitality-bot-tab-group>
            </div>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="permission-table-header">
          <div class="left-table">
            <div class="image">
              <img src="assets/svg/roles.svg" alt="roles" />
            </div>
            <p class="left-table-header">Entity</p>
            <ng-container *ngIf="userForm.get('products').value?.length">
              <ng-container
                *ngFor="
                  let userPermissionFG of permissionConfigsFA['controls'];
                  let index = index
                "
              >
                <p
                  *ngIf="
                    manageProduct === userPermissionFG.get('productType').value
                  "
                  class="left-table-entity"
                  [ngClass]="{ 'color-added': 0 === index % 2 }"
                >
                  {{ userPermissionFG.get('label').value }}
                </p>
              </ng-container>
            </ng-container>
          </div>
          <div class="right-table">
            <div class="box-wrapper">
              <div class="box">
                <p class="label">View</p>
                <p class="paragraph">View General & Sensitive Info</p>
                <div class="float-box">
                  <img src="assets/svg/View.svg" alt="view" />
                </div>
              </div>
              <div class="box">
                <p class="label">Manage</p>
                <p class="paragraph">Create/Delete/Edit</p>
                <div class="float-box">
                  <img src="assets/svg/Manage.svg" alt="manage" />
                </div>
              </div>
            </div>
            <div
              formArrayName="permissionConfigs"
              *ngIf="userForm.get('products').value?.length"
            >
              <div
                *ngFor="
                  let userPermissionFG of permissionConfigsFA['controls'];
                  let userPermissionIdx = index
                "
                [ngClass]="{ 'color-added': 0 === userPermissionIdx % 2 }"
              >
                <div
                  formGroupName="{{ userPermissionIdx }}"
                  *ngIf="
                    manageProduct === userPermissionFG.get('productType').value
                  "
                >
                  <div formGroupName="permissions" class="checkbox-wrapper">
                    <mat-checkbox
                      formControlName="view"
                      [checked]="
                        userPermissionFG.get('permissions').get('view')
                          .value === 1
                          ? true
                          : false
                      "
                    ></mat-checkbox>
                    <mat-checkbox
                      formControlName="manage"
                      [checked]="
                        userPermissionFG.get('permissions').get('manage')
                          .value == 1
                          ? true
                          : false
                      "
                    ></mat-checkbox>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
    <div class="permission-button-wrapper" *ngIf="hasPageState('edit', 'add')">
      <hospitality-bot-button
        [label]="isUpdatingPermissions ? 'Updating User Permissions' : 'Save'"
        (click)="savePermission()"
        [showLoader]="isUpdatingPermissions"
      ></hospitality-bot-button>
    </div>
  </div>
</form>
